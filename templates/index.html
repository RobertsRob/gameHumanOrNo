<!DOCTYPE html>
<html>
<head>
    <title>Async OpenAI Flask App</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <div class="terminal">
        <h1>root@chat:~# <span class="blinking">_</span></h1>

        <h2>Response:</h2>
        <div class="chat_area" id="chat_area">
            <p class="start_chat">Start chatting...</p>
        </div>
        <div class="input_area">
            <textarea id="prompt" rows="2" cols="60" placeholder="Type your message here..."></textarea>
            <button onclick="sendPrompt()">Send</button>
        </div>
        <p id="time_writing"></p>
    </div>


    <script>
        const messages = [];
        let startsMessaging = -1; // ms = s * 10-3E

        document.getElementById('prompt').addEventListener('keydown', function (event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendPrompt();
            }});

        async function sendPrompt() {
            const promptInput = document.getElementById('prompt');
            const chatArea = document.getElementById('chat_area');
            const userMessage = promptInput.value.trim();
            if (!userMessage) return;

            // Добавить сообщение пользователя
            messages.push({ role: 'user', content: userMessage });
            appendMessage('user', userMessage);
            promptInput.value = '';

            // Добавить временное сообщение бота "Thinking..."
            const botPlaceholder = appendMessage('bot', 'Thinking...');
            messages.push({ role: 'bot', content: 'Thinking...' });

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: userMessage })
                });

                const data = await res.json();
                const botMessage = data.response || data.error || 'Error';
                messages[messages.length - 1].content = botMessage;

                let userTextSpeed = userMessage.length / (startsMessaging != -1 ? Date.now() - startsMessaging : -1);
                let timeToWait = startsMessaging * botMessage.length - 900;
                console.log(userTextSpeed);
                await wait(timeToWait >= 0 ? timeToWait : 0);

                // Обновить текст в уже добавленном элементе
                botPlaceholder.textContent = `Bot: ${botMessage}`;
            } catch (err) {
                const errorMessage = 'Request failed.';
                messages[messages.length - 1].content = errorMessage;
                botPlaceholder.textContent = `Bot: ${errorMessage}`;
            }
            startsMessaging = -1;
        }

        function appendMessage(role, content) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.textContent = role === 'user' ? `You: ${content}` : `Bot: ${content}`;
            document.getElementById('chat_area').appendChild(div);
            document.getElementById('chat_area').scrollTop = document.getElementById('chat_area').scrollHeight;
            return div; // Вернём div, чтобы его потом обновить
        }
        

        document.getElementById("prompt").addEventListener("keydown", function(e) {
            const k = e.key;
            if (/^[a-zA-Z0-9]$/.test(k) || ["/", "!", "*", "-", "+", ".", ",", "@", "#", "$"].includes(k)) {
                if(startsMessaging == -1) {
                    startsMessaging = Date.now();
                }
            }
        });

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function update() {
            let timeWriting = startsMessaging != -1 ? Date.now() - startsMessaging : -1;
            document.getElementById("time_writing").innerText = timeWriting;
            
            let val = document.getElementById("prompt").value;
            if ((val == "" || val == undefined)) {
                startsMessaging = -1;
            }
        }


        setInterval(update, 20);

    </script>


</body>
</html>
